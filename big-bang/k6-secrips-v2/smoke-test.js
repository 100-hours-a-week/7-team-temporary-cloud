/**
 * K6 ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ (Smoke Test)
 *
 * ============================================================================
 * ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ë€?
 * ============================================================================
 *
 * ìµœì†Œí•œì˜ ë¶€í•˜ë¡œ ì‹œìŠ¤í…œì˜ ê¸°ë³¸ ê¸°ëŠ¥ì´ ì •ìƒ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.
 *
 * ì™œ í•„ìš”í•œê°€?
 * 1. ë°°í¬ í›„ ë¹ ë¥¸ ê²€ì¦
 *    - ìƒˆ ë²„ì „ ë°°í¬ í›„ ê¸°ë³¸ ê¸°ëŠ¥ì´ ë™ì‘í•˜ëŠ”ì§€ 1-2ë¶„ ë‚´ì— í™•ì¸
 *    - CI/CD íŒŒì´í”„ë¼ì¸ì— í†µí•©í•˜ì—¬ ìë™ ê²€ì¦
 *
 * 2. í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ê²€ì¦
 *    - ë³¸ê²©ì ì¸ ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì „ ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜ ë°œê²¬
 *    - API ì‘ë‹µ í˜•ì‹ ë³€ê²½ ë“±ìœ¼ë¡œ ì¸í•œ ìŠ¤í¬ë¦½íŠ¸ ìˆ˜ì • í•„ìš”ì„± í™•ì¸
 *
 * 3. í™˜ê²½ ì„¤ì • ê²€ì¦
 *    - í…ŒìŠ¤íŠ¸ í™˜ê²½ì˜ ë„¤íŠ¸ì›Œí¬ ì—°ê²°, ì¸ì¦ ì„¤ì • ë“± í™•ì¸
 *    - í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì ê³„ì •ì´ ìœ íš¨í•œì§€ í™•ì¸
 *
 * ì–¸ì œ ì‹¤í–‰í•˜ëŠ”ê°€?
 * - ë§¤ ë°°í¬ í›„ ìë™ ì‹¤í–‰ (CI/CD)
 * - ë³¸ê²©ì ì¸ ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì „ ì‚¬ì „ ê²€ì¦
 * - ê°œë°œ ì¤‘ API ë³€ê²½ í›„ ë™ì‘ í™•ì¸
 *
 * ì‹¤í–‰ ë°©ë²•:
 * k6 run smoke-test.js
 * K6_BASE_URL=https://staging.example.com k6 run smoke-test.js
 */

import { sleep } from 'k6';
import {
    SMOKE_TEST_STAGES,
    COMMON_THRESHOLDS,
} from './config.js';
import {
    signup,
    logout,
    getProfile,
    getSchedulesByDate,
    healthCheck,
    thinkTime,
} from './helpers.js';
import { createReportOutput } from './report-generator.js';

// ============================================================================
// í…ŒìŠ¤íŠ¸ ì„¤ì •
// ============================================================================

export const options = {
    /**
     * ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ë‹¨ê³„ ì„¤ì •
     *
     * 30s: 1 VU â†’ 1m: 5 VU â†’ 30s: 0 VU
     *
     * ì™œ ì´ë ‡ê²Œ ì„¤ì •í•˜ëŠ”ê°€?
     * - ìµœì†Œí•œì˜ ë¶€í•˜ë¡œ ë¹ ë¥´ê²Œ ê²€ì¦ (ì´ 2ë¶„)
     * - 1ëª…ìœ¼ë¡œ ì‹œì‘í•˜ì—¬ ê¸°ë³¸ ë™ì‘ í™•ì¸
     * - 5ëª…ìœ¼ë¡œ ì¦ê°€í•˜ì—¬ ë™ì‹œì„± ê¸°ë³¸ í…ŒìŠ¤íŠ¸
     */
    stages: SMOKE_TEST_STAGES,

    /**
     * Graceful ì¢…ë£Œ ì„¤ì •
     */
    gracefulStop: '10s',
    gracefulRampDown: '10s',

    /**
     * ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ìš© ì„ê³„ê°’
     *
     * ì¼ë°˜ í…ŒìŠ¤íŠ¸ë³´ë‹¤ ì—„ê²©í•œ ê¸°ì¤€ ì ìš©:
     * - ê¸°ë³¸ ê¸°ëŠ¥ì´ë¯€ë¡œ ë¹ ë¥¸ ì‘ë‹µ í•„ìˆ˜
     * - ì‹¤íŒ¨ìœ¨ 0% ëª©í‘œ (0.1% í—ˆìš©)
     */
    thresholds: {
        http_req_duration: ['p(95)<1000', 'p(99)<2000'],
        http_req_failed: ['rate<0.001'], // 0.1% ë¯¸ë§Œ
        checks: ['rate>0.99'], // 99% ì´ìƒì˜ ì²´í¬ í†µê³¼
    },
};

// ============================================================================
// ë©”ì¸ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
// ============================================================================

/**
 * ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤
 *
 * í…ŒìŠ¤íŠ¸ í”Œë¡œìš°:
 * 1. í—¬ìŠ¤ì²´í¬ - ì„œë²„ ê°€ìš©ì„± í™•ì¸
 * 2. íšŒì›ê°€ì… - ì‹ ê·œ ì‚¬ìš©ì ë“±ë¡ (ê³ ìœ  ì´ë©”ì¼ ìë™ ìƒì„±)
 * 3. í”„ë¡œí•„ ì¡°íšŒ - ì¸ì¦ëœ API í˜¸ì¶œ í™•ì¸
 * 4. ìŠ¤ì¼€ì¤„ ì¡°íšŒ - í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ API í™•ì¸
 * 5. ë¡œê·¸ì•„ì›ƒ - ì„¸ì…˜ ì •ë¦¬ í™•ì¸
 *
 * ì™œ íšŒì›ê°€ì…ì„ ì‚¬ìš©í•˜ëŠ”ê°€?
 * - ë§¤ í…ŒìŠ¤íŠ¸ë§ˆë‹¤ ìƒˆë¡œìš´ ì‚¬ìš©ì ìƒì„±ìœ¼ë¡œ ë…ë¦½ì ì¸ í…ŒìŠ¤íŠ¸ ë³´ì¥
 * - ì´ë©”ì¼ì€ íƒ€ì„ìŠ¤íƒ¬í”„ + ëœë¤ ë¬¸ìì—´ë¡œ ì¤‘ë³µ ë°©ì§€
 * - ì‹¤ì œ ì‹ ê·œ ì‚¬ìš©ì í”Œë¡œìš° í…ŒìŠ¤íŠ¸
 */
export default function () {
    // Step 1: í—¬ìŠ¤ì²´í¬
    const isHealthy = healthCheck();
    if (!isHealthy) {
        console.error('Server health check failed - aborting test');
        return;
    }

    thinkTime(0.5, 1);

    // Step 2: íšŒì›ê°€ì… (ê³ ìœ  ì´ë©”ì¼ ìë™ ìƒì„±)
    const signupResult = signup();

    if (!signupResult) {
        console.error(`VU ${__VU}: Signup failed - aborting iteration`);
        return;
    }

    const { accessToken } = signupResult;

    thinkTime(0.5, 1);

    // Step 3: í”„ë¡œí•„ ì¡°íšŒ
    const profile = getProfile(accessToken);
    if (!profile) {
        console.warn(`VU ${__VU}: Get profile failed`);
    }

    thinkTime(0.5, 1);

    // Step 4: ì˜¤ëŠ˜ ìŠ¤ì¼€ì¤„ ì¡°íšŒ
    getSchedulesByDate(accessToken);

    thinkTime(0.5, 1);

    // Step 5: ë¡œê·¸ì•„ì›ƒ
    logout(accessToken);

    // ë‹¤ìŒ ë°˜ë³µ ì „ ì§§ì€ ëŒ€ê¸°
    sleep(1);
}

// ============================================================================
// ë¼ì´í”„ì‚¬ì´í´ í›…
// ============================================================================

/**
 * í…ŒìŠ¤íŠ¸ ì‹œì‘ ì „ ì‹¤í–‰
 * ì „ì²´ í…ŒìŠ¤íŠ¸ì—ì„œ í•œ ë²ˆë§Œ ì‹¤í–‰ë¨
 */
export function setup() {
    console.log('========================================');
    console.log('ğŸ”¥ Smoke Test Started');
    console.log('========================================');
    console.log('Mode: íšŒì›ê°€ì… ê¸°ë°˜ í…ŒìŠ¤íŠ¸ (ê³ ìœ  ì´ë©”ì¼ ìë™ ìƒì„±)');
    console.log('');

    // ì„œë²„ ê°€ìš©ì„± ì‚¬ì „ í™•ì¸
    const isHealthy = healthCheck();
    if (!isHealthy) {
        throw new Error('Server is not responding - cannot proceed with test');
    }

    return { startTime: new Date().toISOString() };
}

/**
 * í…ŒìŠ¤íŠ¸ ì¢…ë£Œ í›„ ì‹¤í–‰
 */
export function teardown(data) {
    console.log('');
    console.log('========================================');
    console.log('âœ… Smoke Test Completed');
    console.log('========================================');
    console.log(`Started: ${data.startTime}`);
    console.log(`Finished: ${new Date().toISOString()}`);
}

/**
 * í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë³´ê³ ì„œ ìë™ ìƒì„±
 */
export function handleSummary(data) {
    return createReportOutput(data, 'smoke-test');
}
